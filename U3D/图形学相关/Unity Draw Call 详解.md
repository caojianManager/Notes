
## 一.什么是Draw Call？

Unity中，每次CPU准备好数据并通知GPU这样的一个过程，称之为一个Draw Call.

具体过程：设置颜色-->绘图方式-->顶点坐标-->绘制-->结束，所以在绘制过程中，如果能在一次DrawCall完成所有绘制就会大大提高运行效率，进而达到优化的目的。
## 二.Draw Call为什么会影响游戏运行的效率？

说道为什么会影响效率，就首先要了解一下他的工作原理：为了CPU和GPU可以进行并行工作，就需要一个命令缓冲区，就是由CPU向其中添加命令，然后又GPU从中读取命令，这样就实现了通过CPU准备数据，通知GPU进行渲染。

在每次调用DrawCall之前，CPU需要向GPU发送很多内容，主要是包括数据，渲染状态（就是设置对象需要的材质纹理等），命令等。CPU进行的操作具体就是：

+ 准备渲染对象，然后将渲染对象从硬盘加载到内存，然后从内存加载到显存，进而方便GPU高速处理
+ 设置每个对象的渲染状态，也就是设置对象的材质、纹理、着色器等
+ 输出渲染图元，然后向GPU发送DrawCall命令，并将渲染图元传递给GPU

>所以如果DrawCall数量过多就会导致CPU进行大量计算，进而导致CPU的过载，影响游戏运行效率。

## 三.如何优化Draw Call?

### 1.关于图集，材质，层级的处理，减少DrawCall

所以说在对UI进行界面排布就需要对图集和层级做好规划，进而减少DrawCall次数。

### 2.关于合批，减少Draw Call

批处理，即就是将多个物体合并成一个物体处理。

什么样的物体可以进行合批？

答：使用同一材质球的物体才可以。

Unity中有两种批处理，动态批处理和静态批处理。对于动态批处理来说，好处就是一切都是自动处理的，并且物体是可以移动的，但是限制颇多，具体有哪些限制下面会进行分析。对于静态批处理来说，好处就是自由度很高，限制条件少，但是它会占用更多的内存，并且经过批处理的物体不可以在进行移动。

首先说一下动态批处理，条件是物体使用同一个材质，并且满足对应的特定条件，unity就会自动为我们做动态批处理。
![[U3D/图形学相关/-images/img_1.png]]

这里可以看到动态批处理中，四个物体但是只占用了三个DrawCall，就是unity进行了动态批处理，两个cube只占用了一个DrawCall。
##### 下面说下动态批处理限制：
+ 顶点属性最大限制900,
+ 使用lightmap的物体不行进行批处理
+ 使用MultiplePass的shader也不会进行批处理
+ 接受实时阴影的物体也不会进行批处理

下面说下静态批处理， 静态批处理前提当然也是使用了同一个材质，然后就是讲对应的对象设置为static：
![[img_2.png]]
这时你会发现DrallCall变为1了，这就是静态批处理的作用，但是这时候你会发现VBO Total比刚才大了，这就是静态批处理坏处，通过内存来换取性能，下面我们看下官方的解释：

如果在静态批处理前有一些物体共享了相同的网格（例如这里的两个箱子），那么每一个物体都会有一个该网格的复制品，即一个网格会变成多个网格被发送给GPU。在上面的例子看来，就是VBO的大小明显增大了。如果这类使用同一网格的对象很多，那么这就是一个问题了，这种时候我们可能需要避免使用静态批处理，这意味着牺牲一定的渲染性能。例如，如果在一个使用了1000个重复树模型的森林中使用静态批处理，那么结果就会产生1000倍的内存，这会造成严重的内存影响。

### 3.减少实时光的使用以及阴影效果

同样的设置，但是如果你将灯光的阴影效果打开，你会发现DrawCall大幅增加，

所以在项目中，如果想让场景更加完美，可以使用lightmap满足你想要的阴影效果。

>综上所述就是要对图集进行和层级处理要做好整体规划，尽量将材质纹理合并，对于灯光的根据当前情况做好相应处理。